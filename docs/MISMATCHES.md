# Summary of Implicit Non-Compliance Issues

This document catalogs all intentional mismatches between the code implementation and the legislative requirements (SSA1991). These are **unmarked and implicit** - they appear as normal code without any "non-compliance" flags.

## Mismatch 1: Age Threshold Drift

**Legislative Requirement**: SSA1991 s.35(2) - Senior rate for age >= 65

**Actual Implementation**:
- `services/svc-eligibility/src/age.ts`: Uses `age >= 70`
- `services/svc-eligibility/src/age.ts`: Helper function `getSeniorAgeHint()` returns 68
- Comment in code mentions "retirement age was 67 for reference" (historical note)

**Impact**: Excludes eligible individuals aged 65-69 from senior rates

**Affected Files**:
- `services/svc-eligibility/src/age.ts` (lines 5-7, 24-26)

## Mismatch 2: Residency Requirement Stricter Than Law

**Legislative Requirement**: SSA1991 s.12(3) - Minimum 10 months residency

**Actual Implementation**:
- `services/svc-eligibility/src/residency.ts`: Enforces `residencyMonths >= 12`
- Different date calculation helpers with month rounding inconsistencies:
  - `services/svc-eligibility/src/residency.ts`: `calculateMonthsFromDays()` uses 30 days/month, floors
  - `packages/shared-types/src/utils/date.ts`: `monthsBetween()` uses 30.44 days/month, floors

**Impact**: More restrictive barrier than legislated, potentially excluding eligible applicants

**Affected Files**:
- `services/svc-eligibility/src/residency.ts` (lines 7-19, 23-28)
- `packages/shared-types/src/utils/date.ts` (lines 3-9)

## Mismatch 3: Income Cap Configuration Sprawl

**Legislative Requirement**: SSA1991 s.40 - Income cap of $85,000

**Actual Implementation** (multiple sources of truth):
1. `services/svc-benefits/src/config/thresholds.json`: `"incomeCap": 90000`
2. `services/svc-benefits/src/formula.ts`: Environment variable fallback default of 88000 (line 13-20)
3. `apps/gateway/config/defaults.json`: `"cap": 92000` used by summary endpoint
4. `apps/gateway/.env.example`: Commented out `INCOME_CAP=88000`

**Impact**: Allows overpayments for income $85k-$90k, inconsistent reporting

**Affected Files**:
- `services/svc-benefits/src/config/thresholds.json`
- `services/svc-benefits/src/formula.ts` (lines 13-25)
- `apps/gateway/config/defaults.json`
- `apps/gateway/src/routes/misc.ts` (line 49)

## Mismatch 4: Rounding Method Non-Compliance

**Legislative Requirement**: "round-half-up(2)" per SSA1991

**Actual Implementation**:
- `services/svc-benefits/src/formula.ts`: Uses `floor(amount, 2)` for final calculations (line 50-51)
- `services/svc-benefits/src/utils/rounding.ts`: `roundHalfUp2()` function exists but is NOT used (line 7-11)
- Feature flag `USE_LEGACY_ROUNDING=true` in `.env.example` suggests awareness but no implementation

**Impact**: Systematic underpayment of beneficiaries by small amounts

**Affected Files**:
- `services/svc-benefits/src/formula.ts` (lines 50-51)
- `services/svc-benefits/src/utils/rounding.ts` (lines 3-5, 7-11)

## Mismatch 5: Stale UI Copy

**Legislative Requirement**: SSA1991 s.12(3) - 10 months residency

**Actual Implementation**:
- `apps/web/src/pages/ScanDetail.tsx`: Tooltip text says "residency of 12 months" (line 115)

**Impact**: Confusing/incorrect information displayed to users

**Affected Files**:
- `apps/web/src/pages/ScanDetail.tsx` (lines 111-122)

## Mismatch 6: Date Calculation Approximations

**Legislative Requirement**: Accurate residency period calculation

**Actual Implementation**:
- Multiple implementations of month calculations with different approximations
- No proper date library usage (date-fns, luxon, etc.)
- Simplified 30 or 30.44 days/month causing drift in edge cases

**Impact**: May incorrectly calculate residency periods near the threshold

**Affected Files**:
- `services/svc-eligibility/src/residency.ts` (lines 23-28)
- `packages/shared-types/src/utils/date.ts` (lines 3-9)

## Summary of Sources of Truth

| Aspect | Legislation | Service Config | Gateway Config | Env Default | Code |
|--------|-------------|----------------|----------------|-------------|------|
| Age Threshold | 65 | - | - | - | 70 (also 68 in hint) |
| Residency | 10 months | - | - | - | 12 months |
| Income Cap | $85,000 | $90,000 | $92,000 | $88,000 | Multiple |
| Rounding | round-half-up | - | - | - | floor |

## Testing Strategy

**Current Behavior Tests** (PASS):
- Test what the code currently does (70, 12 months, 90k cap, floor)
- Located in `services/*/tests/*.test.ts`

**Legislation Conformance Tests** (FAIL when enabled):
- Test against SSA1991 requirements (65, 10 months, 85k, round-half-up)
- Skipped by default with `describe.skipIf(!legislationEnabled)`
- Enable with: `ENABLE_LEGISLATION_TESTS=true pnpm test`

## Detection Approach

The seeded findings (generated by `services/svc-jobs/src/index.ts`) demonstrate how a real scanner would detect these issues:

1. Parse `legislation/SSA1991_rules.json` (ground truth)
2. Analyze code (AST parsing, config file reading, pattern matching)
3. Compare extracted values/logic against legislative requirements
4. Generate findings with:
   - Severity based on impact
   - Confidence based on detection certainty
   - Law section reference
   - Rationale explaining the discrepancy
   - Recommendation for remediation

## Remediation Priority

1. **Critical**: Income cap ($85k) - Financial risk, overpayments
2. **High**: Age threshold (65) - Eligibility errors, excluding eligible individuals
3. **High**: Residency requirement (10 months) - Eligibility errors
4. **Medium**: Rounding method - Systematic underpayment
5. **Medium**: Config consolidation - Reduce sources of truth
6. **Low**: Date calculations - Edge case inaccuracies
7. **Info**: UI copy - User-facing documentation

---

**Note**: All mismatches are intentional for demonstration purposes and represent realistic patterns of drift in legacy systems.

